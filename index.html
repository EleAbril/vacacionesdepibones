<!doctype html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premio Destino de Vacaciones para 4 Pibones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/_sdk/element_sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { box-sizing: border-box; }
        * { font-family: 'Inter', sans-serif; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); } 50% { box-shadow: 0 0 40px rgba(251, 191, 36, 0.8); } }
        .winner-crown { animation: float 2s ease-in-out infinite, pulse-glow 2s ease-in-out infinite; }
        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table-scroll::-webkit-scrollbar { height: 8px; }
        .table-scroll::-webkit-scrollbar-track { background: #1e293b; border-radius: 10px; }
        .table-scroll::-webkit-scrollbar-thumb { background: #fbbf24; border-radius: 10px; }
    </style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
</head>
<body class="h-full bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
    <div id="app" class="w-full h-full overflow-auto pb-20">
        <header class="relative overflow-hidden bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white border-b-4 border-amber-500">
            <div class="relative z-10 px-4 py-16 text-center max-w-4xl mx-auto">
                <div class="mb-6 text-5xl md:text-6xl">üèÜ</div>
                <h1 class="text-3xl md:text-5xl font-bold mb-6">Premio Destino de Vacaciones para 4 Pibones</h1>
                <p class="text-slate-300 mb-8">Selecciona tus destinos favoritos y **confirma** tu voto para que aparezca en el ranking.</p>
                <a href="#voting-section" class="inline-flex items-center gap-2 bg-amber-600 hover:bg-amber-700 text-white font-bold px-8 py-4 rounded-xl transition-all shadow-xl border-2 border-amber-400">üìã ¬°Votar Ahora! ‚ñº</a>
            </div>
        </header>

        <main class="px-4 py-12 max-w-7xl mx-auto">
            <div class="bg-slate-800 rounded-2xl shadow-2xl overflow-hidden border border-slate-700 mb-8">
                <div class="bg-gradient-to-r from-slate-700 to-slate-800 px-6 py-5 border-b border-amber-500 text-center font-bold text-white text-xl">üó∫Ô∏è Tabla de Destinos</div>
                <div class="table-scroll">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-900 border-b-2 border-amber-500 text-slate-200">
                            <tr>
                                <th class="px-4 py-4 text-left">Destino</th>
                                <th class="px-4 py-4 text-left">Salida MAD</th>
                                <th class="px-4 py-4 text-left">Vuelta MAD</th>
                                <th class="px-4 py-4 text-right">Precio/Pers</th>
                                <th class="px-4 py-4 text-right">Hotel 4*</th>
                                <th class="px-4 py-4 text-center">Escala</th>
                                <th class="px-4 py-4 text-center">Reservar</th>
                            </tr>
                        </thead>
                        <tbody id="destinations-body" class="divide-y divide-slate-700 text-slate-200">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="voting-section" class="mt-12 bg-slate-800 rounded-2xl p-6 border border-slate-600 mb-8 scroll-mt-8">
                <h2 class="text-2xl font-bold text-center text-white mb-6">üìã Sistema de Votaci√≥n (3, 2, 1 pts)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="voting-elo"></div>
                    <div id="voting-abby"></div>
                    <div id="voting-cris"></div>
                    <div id="voting-ele"></div>
                </div>
            </div>

            <div class="mb-8 bg-slate-800 rounded-2xl p-6 border-2 border-amber-500">
                <h2 class="text-2xl font-bold text-center text-white mb-6">üèÜ Ranking en Vivo</h2>
                <div id="ranking-container" class="space-y-3"></div>
            </div>
        </main>
    </div>

    <script>
        const DATA_KEY = 'votos_viaje_4pibones_v2';
        const TRAVELERS = ['Elo', 'Abby', 'Cris', 'Ele'];
        const DESTINATIONS = [
            {n:'Belgrado',f:'üá∑üá∏',s:'22:20',v:'18:00',p:'165 ‚Ç¨',h:'27,00 ‚Ç¨',e:'‚úì Directo',l:'https://www.skyscanner.es/transport/vuelos/mad/beg/260702/260714/?adults=4'},
            {n:'Sof√≠a',f:'üáßüá¨',s:'20:30',v:'16:55',p:'138 ‚Ç¨',h:'33,00 ‚Ç¨',e:'‚úì Directo',l:'https://www.skyscanner.es/transport/vuelos/mad/sof/260702/260715/?adults=4'},
            {n:'Bucarest',f:'üá∑üá¥',s:'19:10',v:'06:10',p:'168 ‚Ç¨',h:'20,00 ‚Ç¨',e:'‚úì Directo',l:'https://www.skyscanner.es/transport/vuelos/mad/otp/260702/260714/?adults=4'},
            {n:'Tirana',f:'üá¶üá±',s:'22:40',v:'17:20',p:'175 ‚Ç¨',h:'25,00 ‚Ç¨',e:'‚úì Directo',l:'https://www.skyscanner.es/transport/vuelos/mad/tia/260702/260714/?adults=4'},
            {n:'Cluj-Napoca',f:'üá∑üá¥',s:'20:50',v:'06:10',p:'192 ‚Ç¨',h:'20,00 ‚Ç¨',e:'‚úì Directo',l:'https://www.skyscanner.es/transport/vuelos/mad/clj/260702/260715/?adults=4'},
            {n:'Split',f:'üá≠üá∑',s:'11:30',v:'14:10',p:'225 ‚Ç¨',h:'80,00 ‚Ç¨',e:'‚äô 1h 05m',l:'https://www.skyscanner.es/transport/vuelos/mad/spu/260702/260714/?adults=4'},
            {n:'Dubrovnik',f:'üá≠üá∑',s:'11:30',v:'06:15',p:'215 ‚Ç¨',h:'95,00 ‚Ç¨',e:'‚äô 35m',l:'https://www.skyscanner.es/transport/vuelos/mad/dbv/260702/260715/?adults=4'},
            {n:'Sarajevo',f:'üáßüá¶',s:'06:05',v:'12:10',p:'240 ‚Ç¨',h:'21,00 ‚Ç¨',e:'‚äô 1h 20m',l:'https://www.skyscanner.es/transport/vuelos/mad/sjj/260702/260714/?adults=4'},
            {n:'Skopie',f:'üá≤üá∞',s:'18:45',v:'16:50',p:'210 ‚Ç¨',h:'38,00 ‚Ç¨',e:'‚äô 2h 45m',l:'https://www.skyscanner.es/transport/vuelos/mad/skp/260702/260715/?adults=4'},
            {n:'Malta',f:'üá≤üáπ',s:'09:15',v:'11:55',p:'308 ‚Ç¨',h:'80,00 ‚Ç¨',e:'‚úì Directo',l:'https://www.skyscanner.es/transport/vuelos/mad/mla/260702/260715/?adults=4'}
        ];

        let state = {
            votes: { Elo:{}, Abby:{}, Cris:{}, Ele:{} },
            confirmed: { Elo:false, Abby:false, Cris:false, Ele:false }
        };

        // RENDERIZADO DE TABLA (Para no perder contenido)
        function renderTable() {
            const body = document.getElementById('destinations-body');
            body.innerHTML = DESTINATIONS.map(d => `
                <tr class="hover:bg-slate-700 transition-colors">
                    <td class="px-4 py-4"><div class="flex items-center gap-3"><span class="text-2xl">${d.f}</span><div class="font-semibold text-slate-100">${d.n}</div></div></td>
                    <td class="px-4 py-4">${d.s}<div class="text-xs text-slate-400">2 Jul</div></td>
                    <td class="px-4 py-4">${d.v}<div class="text-xs text-slate-400">14 Jul</div></td>
                    <td class="px-4 py-4 text-right font-bold text-amber-400">${d.p}</td>
                    <td class="px-4 py-4 text-right text-slate-300">${d.h}</td>
                    <td class="px-4 py-4 text-center"><span class="${d.e.includes('‚úì')?'bg-emerald-900 text-emerald-300':'bg-orange-900 text-orange-300'} px-2 py-1 rounded-full text-xs">${d.e}</span></td>
                    <td class="px-4 py-4 text-center"><a href="${d.l}" target="_blank" class="bg-amber-600 px-3 py-2 rounded-lg text-xs text-white">Ver vuelo</a></td>
                </tr>`).join('');
        }

        // PERSISTENCIA
        async function saveData() {
            if (window.dataSdk) {
                try {
                    await window.dataSdk.set(DATA_KEY, state);
                } catch (e) { console.error("Error al guardar:", e); }
            }
        }

        async function loadData() {
            if (window.dataSdk) {
                const cloud = await window.dataSdk.get(DATA_KEY);
                if (cloud && cloud.votes) {
                    state = cloud;
                    renderAll();
                }
            }
        }

        // L√ìGICA DE VOTACI√ìN
        async function handleVote(traveler, destName, points) {
            if (state.confirmed[traveler]) return;

            const tVotes = state.votes[traveler];
            if (tVotes[destName] === points) {
                delete tVotes[destName];
            } else {
                // Eliminar el mismo puntaje de otra ciudad si ya existe
                Object.keys(tVotes).forEach(city => {
                    if (tVotes[city] === points) delete tVotes[city];
                });
                tVotes[destName] = points;
            }
            // Guardamos el estado parcial para que no se pierda al refrescar
            await saveData();
            renderAll();
        }

        async function toggleConfirm(traveler) {
            if (!state.confirmed[traveler]) {
                const count = Object.keys(state.votes[traveler]).length;
                if (count < 3) return alert("Asigna los 3 puntos antes de guardar.");
                state.confirmed[traveler] = true;
            } else {
                state.confirmed[traveler] = false;
            }
            await saveData();
            renderAll();
        }

        // RENDERIZADO DE COMPONENTES
        function renderTraveler(t) {
            const container = document.getElementById(`voting-${t.toLowerCase()}`);
            const v = state.votes[t];
            const isConfirmed = state.confirmed[t];
            const pointsUsed = Object.values(v);

            container.innerHTML = `
                <div class="bg-slate-900 rounded-xl border ${isConfirmed ? 'border-amber-500 shadow-lg' : 'border-slate-700'} overflow-hidden">
                    <div class="${isConfirmed ? 'bg-amber-600' : 'bg-slate-700'} p-3 flex justify-between text-white font-bold">
                        <span>${t}</span>
                        <span class="text-xs">${isConfirmed ? '‚úì GUARDADO' : 'PENDIENTE'}</span>
                    </div>
                    <div class="p-4 space-y-2 bg-slate-800 ${isConfirmed ? 'opacity-50' : ''}">
                        ${DESTINATIONS.map(d => {
                            const currentPts = v[d.n] || 0;
                            return `
                            <div class="flex items-center justify-between p-2 bg-slate-900 rounded border border-slate-700">
                                <span class="text-xs text-white">${d.n}</span>
                                <div class="flex gap-1">
                                    ${[3, 2, 1].map(p => {
                                        const active = currentPts === p;
                                        const disabled = !active && pointsUsed.includes(p);
                                        return `<button 
                                            onclick="handleVote('${t}','${d.n}',${p})"
                                            ${(disabled || isConfirmed) ? 'disabled' : ''}
                                            class="w-8 h-8 rounded text-xs font-bold transition-all ${active ? 'bg-amber-500 text-white' : disabled ? 'bg-slate-800 text-slate-600' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}">
                                            ${p}
                                        </button>`;
                                    }).join('')}
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                    <div class="p-3 bg-slate-900">
                        <button onclick="toggleConfirm('${t}')" class="w-full py-2 rounded-lg font-bold text-sm transition-all ${isConfirmed ? 'border border-slate-600 text-slate-400 hover:bg-slate-800' : 'bg-amber-600 text-white hover:bg-amber-700 shadow-lg'}">
                            ${isConfirmed ? 'Modificar Votaci√≥n' : 'Guardar Votaci√≥n'}
                        </button>
                    </div>
                </div>`;
        }

        function renderRanking() {
            const totals = {};
            DESTINATIONS.forEach(d => totals[d.n] = 0);
            TRAVELERS.forEach(t => {
                if (state.confirmed[t]) {
                    Object.entries(state.votes[t]).forEach(([name, pts]) => {
                        totals[name] += pts;
                    });
                }
            });

            const sorted = Object.entries(totals).sort((a,b) => b[1]-a[1]);
            document.getElementById('ranking-container').innerHTML = sorted.map(([n, p], i) => `
                <div class="flex items-center justify-between p-4 rounded-xl ${i===0 && p>0 ? 'bg-amber-900 border-2 border-amber-500 winner-crown' : 'bg-slate-900'}">
                    <span class="font-bold text-white">${i+1}. ${n}</span>
                    <span class="font-bold text-amber-400">${p} pts</span>
                </div>`).join('');
        }

        function renderAll() {
            TRAVELERS.forEach(renderTraveler);
            renderRanking();
        }

        // INICIO
        async function init() {
            renderTable();
            await loadData();
            
            if (window.dataSdk && window.dataSdk.onUpdate) {
                window.dataSdk.onUpdate(DATA_KEY, (newData) => {
                    if (newData && newData.votes) {
                        state = newData;
                        renderAll();
                    }
                });
            }
            renderAll();
        }

        init();
    </script>
</body>
</html>
