<!doctype html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votaci√≥n Definitiva Verano 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/_sdk/element_sdk.js"></script>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .winner-crown { border: 2px solid #fbbf24 !important; box-shadow: 0 0 25px rgba(251, 191, 36, 0.5); background: rgba(251, 191, 36, 0.1); }
        .table-scroll { overflow-x: auto; scrollbar-width: thin; scrollbar-color: #fbbf24 #1e293b; }
        .desc-text { display: block; margin-top: 4px; color: #9ca3af; font-style: italic; font-size: 0.75rem; line-height: 1.2; }
        .btn-active { background-color: #fbbf24 !important; color: #0f172a !important; transform: scale(1.1); font-weight: 900; }
    </style>
</head>
<body class="h-full bg-slate-950">
    <div id="app" class="max-w-7xl mx-auto px-4 py-12">
        <header class="text-center mb-12 border-b-4 border-amber-500 pb-8">
            <h1 class="text-4xl md:text-6xl font-black uppercase italic tracking-tighter text-white">Viaje Pibones 2026</h1>
            <div id="sync-ui" class="mt-4 inline-flex items-center gap-2 bg-slate-900 px-4 py-2 rounded-full border border-slate-800">
                <div id="status-dot" class="w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse"></div>
                <span id="status-text" class="text-[10px] font-mono uppercase tracking-widest text-slate-400">Conectando...</span>
            </div>
        </header>

        <div class="bg-slate-900 rounded-3xl overflow-hidden border border-slate-800 mb-12 shadow-2xl">
            <div class="table-scroll">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-800 text-slate-400 uppercase text-[10px] font-bold">
                        <tr>
                            <th class="p-5">Destino</th>
                            <th class="p-5">Vuelo</th>
                            <th class="p-5 text-right">Precio</th>
                            <th class="p-5 text-center">Enlace</th>
                        </tr>
                    </thead>
                    <tbody id="dest-body" class="divide-y divide-slate-800"></tbody>
                </table>
            </div>
        </div>

        <div class="mb-12 bg-slate-900 rounded-3xl overflow-hidden border border-slate-800 shadow-2xl">
            <iframe src="https://www.google.com/maps/d/embed?mid=1jdZa06yL7cAbi03SUmNc3t-NMBeznbM&ehbc=2E312F" width="100%" height="450" style="border:0;" allowfullscreen loading="lazy"></iframe>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12" id="voting-grid"></div>

        <div class="bg-slate-900 rounded-[40px] p-8 border-4 border-amber-600 shadow-2xl mb-20">
            <h2 class="text-3xl font-black text-center mb-8 uppercase italic text-white">üèÜ Ranking Global</h2>
            <div id="ranking-container" class="space-y-4"></div>
        </div>
    </div>

    <script>
        const DESTINATIONS = [
            { id: 0, n: 'Belgrado', f: 'üá∑üá∏', c: 'Serbia', d: 'En el coraz√≥n de los Balcanes, ideal para vida nocturna.', p: '165‚Ç¨', u: 'https://www.skyscanner.es/transport/vuelos/mad/beg/260702/260714/?adults=4' },
            { id: 1, n: 'Sof√≠a', f: 'üáßüá¨', c: 'Bulgaria', d: 'Una de las capitales m√°s antiguas, a los pies de la monta√±a Vitosha.', p: '138‚Ç¨', u: 'https://www.skyscanner.es/transport/vuelos/mad/sof/260702/260715/?adults=4' },
            { id: 2, n: 'Bucarest', f: 'üá∑üá¥', c: 'Ruman√≠a', d: 'El "Par√≠s del Este", con una arquitectura impresionante.', p: '168‚Ç¨', u: 'https://www.skyscanner.es/transport/vuelos/mad/otp/260702/260714/?adults=4' },
            { id: 3, n: 'Tirana', f: 'üá¶üá±', c: 'Albania', d: 'Colorida, moderna y muy cerca de playas espectaculares.', p: '175‚Ç¨', u: 'https://www.skyscanner.es/transport/vuelos/mad/tia/260702/260714/?adults=4' },
            { id: 4, n: 'Cluj-Napoca', f: 'üá∑üá¥', c: 'Ruman√≠a', d: 'La capital de Transilvania, joven y universitaria.', p: '192‚Ç¨', u: 'https://www.skyscanner.es/transport/vuelos/mad/clj/260702/260715/?adults=4' },
            { id: 5, n: 'Split', f: 'üá≠üá∑', c: 'Croacia', d: 'Ciudad costera vibrante construida alrededor de un palacio romano.', p: '225‚Ç¨', u: 'https://www.skyscanner.es/transport/vuelos/mad/spu/260702/260714/?adults=4' },
            { id: 6, n: 'Dubrovnik', f: 'üá≠üá∑', c: 'Croacia', d: '"La Perla del Adri√°tico", famosa por sus murallas y el mar.', p: '215‚Ç¨', u: 'https://www.skyscanner.es/transport/vuelos/mad/dbv/260702/260715/?adults=4' },
            { id: 7, n: 'Sarajevo', f: 'üáßüá¶', c: 'Bosnia', d: 'Cruce de culturas entre Oriente y Occidente.', p: '240‚Ç¨', u: 'https://www.skyscanner.es/transport/vuelos/mad/sjj/260702/260714/?adults=4' },
            { id: 8, n: 'Skopie', f: 'üá≤üá∞', c: 'Macedonia', d: 'Ciudad de estatuas y puentes hist√≥ricos.', p: '210‚Ç¨', u: 'https://www.skyscanner.es/transport/vuelos/mad/skp/260702/260715/?adults=4' },
            { id: 9, n: 'Malta', f: 'üá≤üáπ', c: 'Malta', d: 'Una isla mediterr√°nea completa con historia, sol y fiesta.', p: '308‚Ç¨', u: 'https://www.skyscanner.es/transport/vuelos/mad/mla/260702/260715/?adults=4' }
        ];

        const PLAYERS = ['Elo', 'Abby', 'Cris', 'Ele'];
        const STORAGE_ID = 'viaje_2026_ULTIMATE_SECURE_v1';

        let state = {
            v: { 'Elo': {}, 'Abby': {}, 'Cris': {}, 'Ele': {} },
            t: { 'Elo': 0, 'Abby': 0, 'Cris': 0, 'Ele': 0 }
        };

        function uiStatus(type) {
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            if(type === 'syncing') { dot.className = "w-2.5 h-2.5 rounded-full bg-amber-500 animate-pulse"; txt.innerText = "Guardando..."; }
            else if(type === 'ready') { dot.className = "w-2.5 h-2.5 rounded-full bg-emerald-500"; txt.innerText = "Sincronizado"; }
            else { dot.className = "w-2.5 h-2.5 rounded-full bg-red-500"; txt.innerText = "Error SDK"; }
        }

        async function save() {
            if (!window.dataSdk) return;
            uiStatus('syncing');
            try {
                await window.dataSdk.set(STORAGE_ID, JSON.parse(JSON.stringify(state)));
                uiStatus('ready');
            } catch (e) { uiStatus('error'); }
        }

        function merge(remote) {
            if (!remote || !remote.v) return;
            PLAYERS.forEach(p => {
                if ((remote.t[p] || 0) > state.t[p]) {
                    state.v[p] = remote.v[p];
                    state.t[p] = remote.t[p];
                }
            });
            render();
        }

        function handleVote(user, cityId, points) {
            const votes = state.v[user];
            if (votes[cityId] === points) {
                delete votes[cityId];
            } else {
                for (let id in votes) { if (votes[id] === points) delete votes[id]; }
                votes[cityId] = points;
            }
            state.t[user] = Date.now();
            render();
            save();
        }

        function render() {
            // Tabla
            document.getElementById('dest-body').innerHTML = DESTINATIONS.map(d => `
                <tr class="hover:bg-slate-800/50">
                    <td class="p-5">
                        <div class="font-bold text-white text-xs uppercase">${d.f} ${d.n}</div>
                        <div class="text-[10px] text-slate-500 font-bold uppercase">${d.c}</div>
                        <span class="desc-text">${d.d}</span>
                    </td>
                    <td class="p-5 text-[10px] text-slate-400 font-bold uppercase whitespace-nowrap">2 Jul / 15 Jul</td>
                    <td class="p-5 text-right font-black text-amber-500">${d.p}</td>
                    <td class="p-5 text-center"><a href="${d.u}" target="_blank" class="bg-amber-600 px-3 py-1.5 rounded text-[10px] font-bold text-white shadow-lg uppercase">Vuelo</a></td>
                </tr>`).join('');

            // Paneles Votaci√≥n
            const themes = { 'Elo': 'fuchsia-600', 'Abby': 'violet-600', 'Cris': 'cyan-600', 'Ele': 'orange-600' };
            document.getElementById('voting-grid').innerHTML = PLAYERS.map(p => {
                const tv = state.v[p];
                const used = Object.values(tv);
                const color = themes[p];
                return `
                    <div class="bg-slate-900 rounded-2xl border-2 border-${color}/40 overflow-hidden shadow-xl">
                        <div class="bg-slate-800 p-3 text-center border-b border-${color}/40 font-black text-xs uppercase text-white tracking-widest">${p}</div>
                        <div class="p-4 space-y-2 bg-slate-800/20">
                            ${DESTINATIONS.map(d => {
                                const pts = tv[d.id] || 0;
                                return `
                                <div class="flex items-center justify-between p-2 rounded bg-slate-950 border ${pts ? `border-${color} bg-slate-800` : 'border-slate-800'}">
                                    <span class="text-[10px] font-bold text-slate-300 uppercase">${d.n}</span>
                                    <div class="flex gap-1">
                                        ${[3, 2, 1].map(num => {
                                            const active = pts === num;
                                            const locked = !active && used.includes(num);
                                            return `<button class="w-7 h-7 rounded font-black text-[10px] transition-all ${active ? `btn-active` : locked ? 'bg-slate-800 text-slate-700 cursor-not-allowed' : 'bg-slate-800 text-slate-400 hover:text-white'}" onclick="handleVote('${p}',${d.id},${num})" ${locked ? 'disabled' : ''}>${num}</button>`;
                                        }).join('')}
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
            }).join('');

            // Ranking
            const scores = {};
            DESTINATIONS.forEach(d => scores[d.id] = 0);
            PLAYERS.forEach(p => Object.entries(state.v[p]).forEach(([cityId, val]) => scores[cityId] += val));
            const ranking = Object.entries(scores).sort((a,b) => b[1] - a[1]);

            document.getElementById('ranking-container').innerHTML = ranking.map(([id, pts], i) => {
                const d = DESTINATIONS.find(x => x.id == id);
                const win = i === 0 && pts > 0;
                return `
                <div class="flex items-center justify-between p-5 rounded-3xl ${win ? 'winner-crown bg-amber-500/10' : 'bg-slate-950 border border-slate-800'}">
                    <div class="flex items-center gap-4">
                        <span class="text-xl font-black ${win ? 'text-amber-500' : 'text-slate-700'}">${i+1}.</span>
                        <span class="text-3xl">${d.f}</span>
                        <div><div class="font-black text-white uppercase text-sm">${d.n}</div><div class="text-[10px] text-slate-500 font-bold uppercase">${d.c}</div></div>
                    </div>
                    <div class="font-black ${win ? 'text-amber-400' : 'text-slate-500'} text-2xl">${pts} <span class="text-xs uppercase">pts</span></div>
                </div>`;
            }).join('');
        }

        async function init() {
            let attempts = 0;
            while(!window.dataSdk && attempts < 50) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
            }
            if (window.dataSdk) {
                uiStatus('ready');
                try {
                    const saved = await window.dataSdk.get(STORAGE_ID);
                    if (saved) merge(saved);
                    window.dataSdk.onUpdate(STORAGE_ID, (val) => merge(val));
                } catch(e) {}
            } else {
                uiStatus('error');
            }
            render();
        }
        init();
    </script>
</body>
</html>
